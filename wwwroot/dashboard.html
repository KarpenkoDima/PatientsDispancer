<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Рабочий стол - Медицинская система</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }

        .sidebar {
            min-height: calc(100vh - 56px);
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,.1);
            border-right: 1px solid #e9ecef;
        }

            .sidebar .nav-link {
                color: #495057;
                padding: 0.8rem 1rem;
                border-radius: 8px;
                margin: 0.2rem 0.5rem;
                transition: all 0.3s ease;
                font-weight: 500;
            }

                .sidebar .nav-link:hover {
                    background-color: #e9ecef;
                    color: #667eea;
                    transform: translateX(5px);
                }

                .sidebar .nav-link.active {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                }

                .sidebar .nav-link i {
                    width: 20px;
                    margin-right: 10px;
                }

        .main-content {
            padding: 2rem;
            min-height: calc(100vh - 56px);
        }

        .content-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,.08);
            border: none;
            margin-bottom: 2rem;
        }

        .content-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 1.5rem;
        }

        .content-body {
            padding: 1.5rem;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,.08);
            border: none;
            transition: transform 0.3s ease;
        }

            .stat-card:hover {
                transform: translateY(-5px);
            }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }

        .table th {
            background-color: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
        }

        .table td {
            border: none;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .btn-custom {
            border-radius: 20px;
            padding: 0.5rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

            .btn-custom:hover {
                transform: translateY(-2px);
            }

        .breadcrumb {
            background: transparent;
            margin-bottom: 1rem;
        }

        .breadcrumb-item.active {
            color: #667eea;
        }

        .user-info {
            display: flex;
            align-items: center;
            color: white;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                top: 56px;
                width: 250px;
                z-index: 1000;
                transition: left 0.3s ease;
            }

                .sidebar.show {
                    left: 0;
                }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
        }

        /* для карты регистрации */
        .register-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,.08);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .register-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
        }

        .info-box {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            background-color: #f8f9fa;
            height: 100%;
        }

            .info-box h6 {
                color: #667eea;
                margin-bottom: 1rem;
                font-weight: 600;
            }

        .info-table {
            width: 100%;
        }

            .info-table td {
                padding: 0.5rem 0;
                border: none;
            }

                .info-table td:first-child {
                    font-weight: 600;
                    color: #495057;
                    width: 60%;
                }

        .badge-custom {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .notes-box {
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 1.5rem;
            background-color: #fffbea;
        }

            .notes-box h6 {
                color: #856404;
                margin-bottom: 0.5rem;
            }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-light d-md-none me-3" id="sidebarToggle"><i class="bi bi-list"></i></button>
                <a class="navbar-brand" href="#"><i class="bi bi-heart-pulse-fill me-2"></i>Медицинская система</a>
            </div>
            <div class="d-flex align-items-center">
                <div class="user-info me-3">
                    <div class="user-avatar"><i class="bi bi-person-fill"></i></div>
                    <div>
                        <div class="fw-semibold" id="userNameDisplay"></div>
                        <small class="opacity-75" id="userRoleDisplay"></small>
                    </div>
                </div>
                <button class="btn btn-outline-light btn-sm" onclick="logout()"><i class="bi bi-box-arrow-right me-1"></i>Выход</button>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-3 col-lg-2 sidebar" id="sidebar">
                <div class="position-sticky pt-3"><ul class="nav flex-column" id="sideMenu"></ul></div>
            </nav>
            <main class="col-md-9 ms-sm-auto col-lg-10 main-content">
                <nav aria-label="breadcrumb"><ol class="breadcrumb" id="breadcrumb"></ol></nav>
                <div id="mainContent"></div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentUser = null;
        let currentSection = 'dashboard';
        let customersCache = []; // <-- 1. Создаем кэш для хранения списка пациентов
        let lands = []; // справочник учатсков
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                redirectToLogin();
                return;
            }

            try {
                const response = await fetch('/api/customer', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`Server returned status ${response.status}Details:<pre>${errorDetails}</pre>`);

                }

                currentUser = {
                    name: localStorage.getItem('userName') || 'Пользователь',
                    role: localStorage.getItem('userRole') || 'Пользователь',
                    sensitivityLevel: localStorage.getItem('sensitivityLevel') || 'Sensitive_Low'
                };          

                initializeUI();
                initializeModals(); // Добавим для вызова модального окна
                loadDictionaries();

            } catch (error) {
                console.error('Token validation failed:', error);
                // вместо редиректа redirectToLogin(); покажем ошибку прямо на странице
                document.body.innerHTML = `<div class="alert alert-changer m-5">
                            <h1>Ошибка аутентификации</h1>
                            <p>Не удалось проверить вашу сессию. Сервер вернул ошибку.</p>
                            <p><b>Подробности:</b> ${error.message}</p><hr>
                            <p>Это может означать, что токен недействителен или есть проблема на сервере. Пожалуйста, попробуйте войти снова.</p>
                            <a href="login.html" class="btn btn-primary" onclick="localStorage.clear()">Вернуться на страницу входа</a> </div>`;
            }
        });

        function initializeUI() {
            updateUserInfo();
            buildMenu();
            loadSection('dashboard');
            setupEventListeners();            
        }

        function updateUserInfo() {
            document.getElementById('userNameDisplay').textContent = currentUser.name;
            document.getElementById('userRoleDisplay').textContent = currentUser.role;
        }

        function buildMenu() {
            const menu = document.getElementById('sideMenu');
            const items = [
                { id: 'dashboard', icon: 'house', text: 'Главная', roles: ['Администратор', 'Оператор', 'Регистратор'] },
                { id: 'patients', icon: 'people', text: 'Пациенты', roles: ['Администратор', 'Оператор', 'Регистратор'] },
                { id: 'appointments', icon: 'calendar-check', text: 'Записи на прием', roles: ['Администратор', 'Оператор', 'Регистратор'] },
                { id: 'medical-records', icon: 'clipboard-heart', text: 'Мед. карты', roles: ['Администратор', 'Оператор'] },
                { id: 'reports', icon: 'graph-up', text: 'Отчеты', roles: ['Администратор'] },
                { id: 'users', icon: 'person-gear', text: 'Пользователи', roles: ['Администратор'] },
                { id: 'settings', icon: 'gear', text: 'Настройки', roles: ['Администратор'] },
            ];

            menu.innerHTML = items
                .filter(item => item.roles.includes(currentUser.role))
                .map(item => `
                                    <li class="nav-item">
                                        <a class="nav-link ${currentSection === item.id ? 'active' : ''}" href="#" onclick="loadSection('${item.id}', event)">
                                            <i class="bi bi-${item.icon} me-2"></i>${item.text}
                                        </a>
                                    </li>
                                `).join('');
        }

        function loadSection(section, event) {
            if (event) event.preventDefault();
            currentSection = section;
            buildMenu();
            updateBreadcrumb(section);
            const content = document.getElementById('mainContent');
            switch (section) {
                case 'dashboard':
                    content.innerHTML = document.getElementById('dashboardContentTemplate').innerHTML;
                    break;
                case 'patients':
                    loadPatientsSection();
                    break;
                default:
                    content.innerHTML = `<div class="card content-card"><div class="content-header"><h5 class="mb-0">Раздел "${getSectionTitle(section)}"</h5></div><div class="content-body"><p>Этот раздел находится в разработке.</p></div></div>`;
            }
        }

        async function loadDictionaries() {
            // Пока загружаем только участки
            const token = localStorage.getItem('token');
            try {
                const responseLands = await fetch('/api/Dictionary/lands', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!responseLands.ok) {
                    const errorDetails = await responseLands.text();
                    throw new Error(`Server returned status ${responseLands.status}Details:<pre>${errorDetails}</pre>`);
                }
                const selectLand = document.getElementById('dataSelectLand');
                if (lands.length <= 0) lands = await responseLands.json();
                selectLand.innerHTML = '';
                lands.forEach(land => {
                    // Создаем новый элемент <option>
                    const option = document.createElement('option');

                    // Устанавливаем значение (value) и видимый текст (textContent)
                    // **ВАЖНО:** Замените 'item.id' и 'item.name' 
                    // на реальные имена полей из вашего API.
                    option.value = land.LandID;
                    option.textContent = land.Name;

                    // 7. Добавляем созданный <option> в наш <select>
                    selectLand.appendChild(option);
                });
            }
            catch (error) {
                alert(error.message);
            }

        }

        async function loadPatientsSection() {
            const content = document.getElementById('mainContent');
            // используем sensitivityLevel для более точного контроля, как в API
            const canEdit = currentUser.sensitivityLevel === 'Sensitive_medium' ||
                currentUser.sensitivityLevel === 'Sensitive_high';
            const canDelete = currentUser.sensitivityLevel === 'Sensitive_high';

            content.innerHTML = content.innerHTML = `
                                     <div class="d-flex justify-content-between align-items-center mb-4">
                                         <h2>Управление пациентами</h2>
                                         ${canEdit ? `<button class="btn btn-primary btn-custom"
                             id="newPatientBtn"><i class="bi bi-person-plus me-2"></i>Новый пациент</button>` :
                    ''}
                                     </div>
                                     <div class="card content-card">
                                         <div class="content-body">
                                             <div class="table-responsive">
                                                 <table class="table">
                                                     <thead><tr><th>ФИО</th><th>Дата рождения</th><th>№ карты</
                             th><th>Код</th><th>Действия</th></tr></thead>
                                                     <tbody id="patientsTableBody"><tr><td colspan="5" class=
                             "text-center">Загрузка данных...</td></tr></tbody>
                                                 </table>
                                             </div>
                                         </div>
                                     </div>`;

         
            // Сразу после обновления innerHTML, находим кнопку и вешаем обработчик
            if (canEdit) {
                document.getElementById('newPatientBtn').addEventListener('click', handleCreate);
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/customer', { headers: { 'Authorization': `Bearer ${token}` } });
                const tbody = document.getElementById('patientsTableBody');
                tbody.innerHTML = '';
                if (!response.ok) throw new Error(`Ошибка ${response.status}`);

                const data = await response.json();
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Пациенты не найдены.</td></tr>';
                    return;
                }
                customersCache = data; // <-- 2. Сохраняем полученные данные в кэш
                data.forEach(customer => {
                    // Деструктуризация для Edge (может помочь?)
                    const { FirstName, MiddleName, LastName, Birthday } = customer;
                    const row = document.createElement('tr');
                    const birthday = Birthday ? new Date(Birthday).toLocaleDateString() : 'N/A';
                    const parts = [FirstName, MiddleName, LastName];
                    const fullName = parts.filter(Boolean).join(' ');

                    // Генерируем кнопки действий на основе прав
                    let actionButtons = '';
                    // НОВАЯ КНОПКА - доступна всем
                    actionButtons += `<button class="btn btn-sm btn-outline-success me-1" 
                                        onclick="openMedCard(${customer.CustomerID}, '${customer.LastName} ${customer.FirstName}')" 
                                        title="Медицинская карта">
                                        <i class="bi bi-clipboard-heart">Мед.Карта</i>
                                    </button>`;
                    if (canEdit) {
                        actionButtons += `<button class="btn btn-sm btn-outline-primary
                                me - 1" onclick="handleEdit(${customer.CustomerID})">Ред.</button>`;
                    }
                    if (canDelete) {
                        actionButtons += `<button class="btn btn-sm btn-outline-danger"
              onclick="handleDelete(${customer.CustomerID})">Удал.</button>`;
                    }

                    row.innerHTML = `
                                <td><a href="#" onclick="loadPatientDetailSection(${customer.CustomerID},'${fullName.replace(/'/g, "\\'")}')">${fullName}</a></td>
                                <td>${birthday}</td>
                                <td>${customer.MedCard || 'N/A'}</td>
                                <td>${customer.CodeCustomer || 'N/A'}</td>
                                <td>${actionButtons || '-----'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                document.getElementById('patientsTableBody').innerHTML = `<tr><td colspan="5" class="text-center text-danger">${error.message}: Не удалось загрузить данные.</td></tr>`;
                redirectToLogin();
            }
        }

        function updateBreadcrumb(section) {
            const breadcrumb = document.getElementById('breadcrumb');
            const title = getSectionTitle(section);
            breadcrumb.innerHTML = section === 'dashboard'
                ? '<li class="breadcrumb-item active">Главная</li>'
                : `<li class="breadcrumb-item"><a href="#" onclick="loadSection('dashboard', event)">Главная</a></li><li class="breadcrumb-item active">${title}</li>`;
        }

        function getSectionTitle(section) {
            const titles = { 'dashboard': 'Главная', 'patients': 'Пациенты', 'appointments': 'Записи на прием', 'medical-records': 'Мед. карты', 'reports': 'Отчеты', 'users': 'Пользователи', 'settings': 'Настройки' };
            return titles[section] || section;
        }

        function redirectToLogin() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        function logout() {
            redirectToLogin();
        }

        function setupEventListeners() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            if (sidebarToggle) sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('show'));
            document.addEventListener('click', (e) => {
                if (window.innerWidth < 768 && sidebar && !sidebar.contains(e.target) && sidebarToggle && !sidebarToggle.contains(e.target)) {
                    sidebar.classList.remove('show');
                }
            });
        }

        // --- НОВЫЙ БЛОК: ЛОГИКА ДЛЯ CRUD ОПЕРАЦИЙ ---
        let customerModal = null; // переменная для хранения экземпляра модального окна

        //вызываем эту йункцию один раз, чтобы инициализировать модалное окно
        function initializeModals() {
            const modalElement = document.getElementById('customerModal');
            if (modalElement) {
                customerModal = new bootstrap.Modal(modalElement);
                document.getElementById('saveCustomerBtn').addEventListener('click', handleSave);
            }

            // ДОБАВИМ БЛОК КОДА ДЛЯ ОКНА МЕДКАРТЫ
            const registerElementModal = document.getElementById('registerEntryModal');
            if (registerElementModal) {
                registerEntryModal = new bootstrap.Modal(registerElementModal);
                document.getElementById('saveRegisterEntryBtn').addEventListener('click', handleSaveRegisterEntry);
            }
        }

        // Вызываем инициализацию модального окна внутри главной функции
        // Заменить вызов initializeUI(); в коде на этот:
        // initializeUI(); -> initializeUI(); initializeModal();
        // Или просто добавим initializeModals(); после initializeUI();
        function handleCreate() {
            document.getElementById('customerForm').reset();
            document.getElementById('customerId').value = '';
            document.getElementById('customerModalLabel').textContent = 'Новый пациент';
            customerModal.show();
        }

        async function handleEdit(customerId) {
            document.getElementById('customerForm').reset();
            const customer = customersCache.find(c => c.CustomerID === customerId);
            if (false == customer) {
                // пробуем поискать в БД
                try {
                    const token = localStorage.getItem('token');
                    // ВАЖНОЖ Убедиться, что у нашего API есть метод для получения пользователя по ID (его пока нет)
                    const response = await fetch(`/api/customer/${customerId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (false == response.ok) {
                        throw new Error('Не удалось получить данные пациента');
                    }
                    customer = await response.json();
                } catch (error) {
                    alert(error.message);
                }
            }
            document.getElementById('customerId').value = customer.CustomerID;
            document.getElementById('lastName').value = customer.LastName;
            document.getElementById('firstName').value = customer.FirstName;
            document.getElementById('middleName').value = customer.MiddleName || '';
            document.getElementById('birthday').value = customer.Birthday ? customer.Birthday.split('T')[0] : '';
            document.getElementById('medCard').value = customer.MedCard || '';
            document.getElementById('codeCustomer').value = customer.CodeCustomer || '';

            document.getElementById('customerModalLabel').textContent = 'Редактировать данные пациента';
            customerModal.show();
        }

        async function handleDelete(customerId) {
            if (false == confirm('Вы уверены, что хотите удалить этого пациента? Это действие необратимо.')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/customer/${customerId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (false == response.ok) {
                    throw new Error('Ошибка при удалении пациента.');
                }
                loadPatientsSection(); // Перезагружаем секцию для обновления списка
            } catch (error) {
                alert(error.message);
            }
        }

        async function handleSave() {
            const id = document.getElementById('customerId').value;
            const customerData = {
                lastName: document.getElementById('lastName').value,
                firstName: document.getElementById('firstName').value,
                middleName: document.getElementById('middleName').value,
                birthday: document.getElementById('birthday').value || null,
                medCard: document.getElementById('medCard').value ?
                    parseInt(document.getElementById('medCard').value) : null,
                codeCustomer: document.getElementById('codeCustomer').value ?
                    parseInt(document.getElementById('codeCustomer').value) : null
            };

            // Новый?
            const isNew = !id;
            const url = isNew ? '/api/customer' : `/api/customer/${id}`;
            const method = isNew ? 'POST' : 'PUT';

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(customerData)
                });

                if (false == response.ok) {
                    const errorResult = await response.json();
                    const errorMsg = errorResult.title || 'Неизвестная ошибка сохранеия';
                    throw new Error(errorMsg);
                }

                customerModal.hide();
                loadPatientsSection(); // Обновляем список после сохранения
            } catch (error) {
                alert(`Ошибка сохраннеия ${error.message}`);
            }
        }

        // --- НОВЫЙ БЛОК: ЛОГИКА ДЛЯ РАБОТЫ С МЕДКАРТОЙ (РЕГИСТРОМ) ---
        let registerEntryModal = null; // переменная для второго модального окна

        // Функция для загрузки детальной информации о пациенте и его медкарте
        async function loadPatientDetailSection(customerId, customerName) {
            const content = document.getElementById('mainContent');
            const canEdit = currentUser.sensitivityLevel === 'Sensitive_medium' || currentUser.sensitivityLevel === 'Sensitive_high';

            // Обновляем "хлебные крошки"
            document.getElementById('breadcrumb').innerHTML = `
                <li class="breadcrumb-item"><a href="#" onclick="loadSection('dashboard', event)">Главная</a></li>
                <li class="breadcrumb-item"><a href="#" onclick="loadSection('patients', event)">Пациенты</a></li>
                <li class="breadcrumb-item active">${customerName}</li>
                `;

            content.innerHTML = `<div class="d-flex justify-content-between align-items-center mb-4">
                <h2>медкарта пациента: ${customerName}</h2>
                ${canEdit ? `<button class="btn btn-primary btn-customer" onclick="handleCreateRegisterEntry(${customerId})"><i class="bi bi-plus-circle me-2"></i>
                Добавить запись</button>`: ''}
                </div>
                <div class="card content-card">
                    <div class "content-body">
                      <div class="table-respo0nsive">
                        <table class="table">
                          <thead><tr><th>Дата</th><th>Диагноз</th><th>Заметки</th><th>Действия</td></tr></thead>
                          <tbody id="registerTableBody"><tr><td colspan="4" class="text-center">Загрузка записей...</td></tr></tbody>
                        </table>
                       </div>
                    </div>`;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/customer/${customerId}/register`,
                    {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                const tbody = document.getElementById('registerTableBody');
                tbody.innerHTML = '';
                if (false == response.ok) {
                    throw new Error(`Ошибка ${response.status}`);
                }
                const data = await response.json();
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">Записи в медкарте отсутствуют.</td ></tr';
                    return;
                }

                const canDelete = currentUser.sensitivityLevel === 'Sensitive_high';
                data.forEach(entry => {
                    const row = document.createElement('tr');
                    const registerDate = new Date(entry.FirstRegister).toLocaleDateString();

                    let actionButtons = '';
                    if (canEdit) {
                        actionButtons += `<button class="btn btn-sm btn-outline-primary
           me-1" onclick="handleEditRegisterEntry(${entry.RegisterID}, ${customerId}
           )">Ред.</button>`;
                    }
                    if (canDelete) {
                        actionButtons += `<button class="btn btn-sm btn-outline-danger"
                            onclick="handleDeleteRegisterEntry(${entry.RegisterID}, ${customerId}, '${customerName}')">Удал.</button>`;
                    }

                    row.innerHTML = `
                            <td>${registerDate}</td>
                            <td>${entry.Diagnosis || 'N/A'}</td>
                            <td>${entry.Notabene || 'N/A'}</td>
                            <td>${actionButtons || 'нет прав'}</td>
                        `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                document.getElementById('registerTableBody').innerHTML = `<tr><td colspan="4" class="text-center text-danger">${error.message}: Не удалось загрузить записи. </td></tr>`;
            }
        }

        function handleCreateRegisterEntry(customerId) {
            document.getElementById('registerEntryForm').reset();
            document.getElementById('registerEntryId').value = '';
            document.getElementById('registerEntryCustomerId').value = customerId;
            document.getElementById('registerEntryModalLabel').textContent = 'Новая запись в медкарте';
            registerEntryModal.show();
        }

        async function handleSaveRegisterEntry() {
            const registerId = document.getElementById('registerEntryId').value;
            const customerId = document.getElementById('registerEntryCustomerId').value;
            const customerName = document.querySelector('.breadcrumb .active').textContent;
            let selectedOptionElement = -1;

            const selectElement = document.getElementById('dataSelectLand');

            if (selectElement.selectedIndex !== -1) {
                selectedOptionElement = selectElement.options[selectElement.selectedIndex];
            }
            else throw new Error("Номер учатска дожен біть выбран");

            const entryData = {
                FirstRegister: document.getElementById('firstRegister').value || null,
                FirstDeregister: document.getElementById('firstDeregister').value || null,
                Diagnosis: document.getElementById('diagnosis').value || '',
                LandID: selectedOptionElement.value,
                NotaBene: document.getElementById('notes').value || ''
            };
           
            const isNew = !registerId;
            const url = isNew ? `/api/customer/${customerId}/register` :
                `/api/customer/${customerId}/register/${registerId}`;
            const method = isNew ? 'POST' : 'PUT';

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(entryData)
                });

                if (false == response.ok) {
                    throw new Error('Ошибка сохранения записи.');
                }

                registerEntryModal.hide();
                loadPatientDetailSection(customerId, customerName);
            } catch (error) {
                alert(error.message);
            }
        }
        async function handleEditRegisterEntry(registerId, customerId) {
            document.getElementById('registerEntryForm').reset();
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/customer/${customerId}/register/${registerId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (false == response.ok) {
                    throw new Error('Не удалось получить данные записи');
                }

                const data = await response.json();
               
                // 'data' - это массив, 'entry' - это ОБЪЕКТ из этого массива
                data.forEach(entry => {

                    // УБИРАЕМ [0] ОТСЮДА
                    document.getElementById('registerEntryId').value = entry.RegisterID;
                    document.getElementById('registerEntryCustomerId').value = entry.CustomerID;

                    // ИСПРАВЛЯЕМ УСТАНОВКУ ДАТЫ:
                    // 1. Проверяем, есть ли дата
                    // 2. Используем .split('T')[0] для формата YYYY-MM-DD,
                    //    который нужен для <input type="date">
                    let date = entry.FirstRegister ? entry.FirstRegister.split('T')[0] : '';
                    document.getElementById('firstRegister').value = date;

                    // Ваш alert(new Date(entry.FirstRegister).toLocaleDateString()) может работать,
                    // но .toLocaleDateString() дает не тот формат (например, "20.01.2019"),
                    // который нужен для <input>. Ему нужен "2019-01-20".

                    // Эти строки у вас УЖЕ БЫЛИ ПРАВИЛЬНЫЕ (т.к. использовали 'entry.')
                    document.getElementById('firstDeregister').value = entry.FirstDeregister ? entry.FirstDeregister.split('T')[0] : '';
                    document.getElementById('diagnosis').value = entry.Diagnosis || '';
                    document.getElementById('notes').value = entry.NotaBene || '';
                    document.getElementById('registerEntryModalLabel').textContent = '';
                    // Загружаем участок
                    selectLand(entry.LandID);
                    registerEntryModal.show();
                });
            } catch (error) {
                alert(error.message);
            }
        }

        function selectLand(LandID) {
            if (LandID) {


                const dataSelectLand = document.getElementById('dataSelectLand');

                lands.forEach(land => {
                    dataSelectLand.value = LandID.toString();
                });
            }
        }

        async function handleDeleteRegisterEntry(registerId, customerId, customerName) {
            if (false == confirm('Вы уверены, что хотите удалить эту регистрацию?')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/customer/0/register/${registerId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Ошибка удаления');
                }

                // TODO: перезагрузить текущую карту
                alert('Регистрация удалена. TODO: обновить список');

            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        // ===== БЛОК РАБОТЫ С РЕГИСТРАЦИЯМИ ======
        
        async function openMedCard(customerId, customerName) {
            currentSection = 'medical-card';
            updateBreadcrumb(customerName);

            const content = document.getElementById('mainContent');

            // Показываем загрузку
            content.innerHTML = `
             <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>Медицинская карта</h2>
                <p class="text-muted mb-0">Пациент: ${customerName}</p>
            </div>
            <button class="btn btn-primary btn-custom" id="addRegisterBtn">
                <i class="bi bi-plus-circle me-2"></i>Добавить регистрацию
            </button>
        </div>
        <div id="registrationsContainer" class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
        </div>
            `;

            // Загружаем данные
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/customer/${customerId}/register`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (false == response.ok) {
                    throw new Error('Ошибка загрузки данных');
                }

                const registers = await response.json();
                renderRegistrations(registers, customerId, customerName);

                // Обработчикеи на кнопку добавления
                const canEdit = currentUser.sensitivityLevel === 'Sensitive_medium' ||
                    currentUser.sensitivityLevel === 'Sensitive_high';
                if (canEdit) {
                    document.getElementById('addRegisterBtn').addEventListener('click', () => handleCreateRegisterEntry(customerId));
                }
                else {
                    document.getElementById('addRegisterBtn').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('registrationsContainer').innerHTML = `
                <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Ошибка загрузки: ${error.message}
            </div>
        `;
            }
        }
        
        function renderRegistrations(registers, customerId, customerName) {
            const container = document.getElementById('registrationsContainer');

            if (registers.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    У пациента пока нет записей в медицинской карте.
                    Нажмите кнопку "Добавить регистрацию" для создания первой записи.
                     </div>
                `;
                return;
            }

            // Определяем права
            const canEdit = currentUser.sensitivityLevel === 'Sensitive_medium' ||
                currentUser.sensitivityLevel === 'Sensitive_high';
            const canDelete = currentUser.sensitivityLevel === 'Sensitive_high';

            // Сгенерируем карточки
            container.innerHTML = registers.map(reg => createRegisterCard(reg, canEdit, canDelete)).join('');
        }
        
        function createRegisterCard(reg, canEdit, canDelete) {
            // Форматируем даты
            const formatDate = (date) => date ? new Date(date).toLocaleDateString('ru-RU') : '-';

            const firstRegDate = formatDate(reg.FirstRegister);
            const firstDeregDate = formatDate(reg.FirstDeregister);
            const secondRegDate = formatDate(reg.SecondRegister);
            const secondDeregDate = formatDate(reg.SecondDeRegister);

            // определяем статус
            let statusBadge = '';
            if (reg.FirstDeregister) {
                statusBadge = '<span class="badge bg-secondary badge-custom ms-2">Снят с учёта</span>';
            } else {
                statusBadge = '<span class="badge bg-success badge-custom ms-2">На учёте</span>';
            }

            // Кнопки действий
            let = actionButtons = '';
            if (canEdit) {
                actionButtons += `<button class="btn btn-sm btn-light me-1" onclick="handleEditRegisterEntry(${reg.RegisterID}, ${reg.CustomerID})" title="Редактировать">
                                 <i class="bi bi-pencil"></i>
                                 </button>`;
            }
            if (canDelete) {
                actionButtons += `<button class="btn btn-sm btn-danger" onclick="handleDeleteRegisterEntry(${reg.RegisterID}, ${reg.customerID})" title="Удалить">
                                  <i class="bi bi-trash"></i>
                                  </button>`;
            }

            // Блок повторной регистрации (если есть)
            const secondRegistration = reg.SecondRegister ? `
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info mb-0">
                    <h6 class="alert-heading">
                        <i class="bi bi-arrow-repeat"></i> Повторная регистрация
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1">
                                <strong>Повторно взят на учёт:</strong> 
                                <span class="badge bg-primary">${secondRegDate}</span>
                            </p>
                            <p class="mb-0">
                                <strong>Тип:</strong> ${reg.SecondRegisterTypeID || '-'}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1">
                                <strong>Повторно снят:</strong> 
                                <span class="badge bg-warning text-dark">${secondDeregDate}</span>
                            </p>
                            <p class="mb-0">
                                <strong>Причина:</strong> ${reg.WhySecondDeRegisterID || '-'}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    ` : '';

            return `
        <div class="register-card">
            <div class="register-card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">
                            <i class="bi bi-clipboard-pulse"></i> 
                            Регистрация №${reg.RegisterID}
                            ${statusBadge}
                        </h6>
                        <small class="opacity-75">
                            Последнее изменение: ${formatDate(reg.ModifiedDate)}
                        </small>
                    </div>
                    <div>
                        ${actionButtons}
                    </div>
                </div>
            </div>
            
            <div class="card-body p-4">
                <div class="row mb-3">
                    <!-- Диагноз и учёт -->
                    <div class="col-md-6 mb-3">
                        <div class="info-box">
                            <h6>
                                <i class="bi bi-clipboard-data"></i> Диагноз и учёт
                            </h6>
                            <table class="info-table">
                                <tr>
                                    <td>Первый раз взят на учёт:</td>
                                    <td><span class="badge bg-primary">${firstRegDate}</span></td>
                                </tr>
                                <tr>
                                    <td>Учёт:</td>
                                    <td>${reg.RegisterTypeID || '-'}</td>
                                </tr>
                                <tr>
                                    <td>Шифр (МКБ-10):</td>
                                    <td><code class="text-danger fs-5">${reg.Diagnosis || '-'}</code></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Снятие с учёта -->
                    <div class="col-md-6 mb-3">
                        <div class="info-box">
                            <h6>
                                <i class="bi bi-calendar-x"></i> Снятие с учёта
                            </h6>
                            <table class="info-table">
                                <tr>
                                    <td>Снят с учёта:</td>
                                    <td><span class="badge bg-warning text-dark">${firstDeregDate}</span></td>
                                </tr>
                                <tr>
                                    <td>Причина:</td>
                                    <td>${reg.WhyDeRegisterID || '-'}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                ${secondRegistration}

                ${reg.Notes ? `
                <div class="row">
                    <div class="col-12">
                        <div class="notes-box">
                            <h6><i class="bi bi-sticky"></i> Примечания</h6>
                            <p class="mb-0 text-dark">${reg.Notes}</p>
                        </div>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `;
    }
    </script>

    <template id="dashboardContentTemplate">
        <div id="dashboardContent">
            <h2 class="mb-4">Добро пожаловать в медицинскую систему</h2>
            <div class="card content-card">
                <div class="content-body">
                    <p>Это главная страница. Выберите раздел в меню слева для начала работы.</p>
                </div>
            </div>
        </div>
    </template>

    <!-- МОДАЛЬНОЕ ОКНО ДЛЯ СОЗДАНИЯ/РЕДАКТИРОВАНИЯ ПАЦИЕНТА -->
    <div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerModalLabel">
                        Данные пациента</
                        h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerForm">
                        <input type="hidden" id="customerId">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="lastName" class="form-label">
                                    Фамилия</
                                    label>
                                    <input type="text" class="form-control" id="lastName"
                                           required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="firstName" class="form-label">Имя</label>
                                <input type="text" class="form-control" id="firstName"
                                       required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="middleName" class="form-label">
                                    Отчество</
                                    label>
                                    <input type="text" class="form-control" id="middleName">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="birthday" class="form-label">
                                    Дата рождения
                                </label>
                                <input type="date" class="form-control" id="birthday">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="medCard" class="form-label">
                                    № мед. карты</
                                    label>
                                    <input type="number" class="form-control" id="medCard">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="codeCustomer" class="form-label">
                                    Код
                                    пациента
                                </label>
                                <input type="number" class="form-control" id="codeCustomer">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Отмена
                    </button>
                    <button type="button" class="btn btn-primary" id="saveCustomerBtn">
                        Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!--МОДАЛЬНОЕН ОКНО ДЛЯ ЗАПИСЕЙ МЕДКАРТЫ-->
    <div class="modal fade" id="registerEntryModal" tabindex="-1" aria-labelledby="registerEntryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerEntryModalLabel">Запись в медкарте</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            <div class="modal-body">
                <form id="registerEntryForm">
                    <!-- Скрытые поля для ID записи и ID пациента -->
    <input type="hidden" id="registerEntryId">
    <input type="hidden" id="registerEntryCustomerId">
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="firstRegister" class="form-label">
                Дата начала
            </label>
            <input type="date" class="form-control" id="firstRegister" required>
        </div>
        <div class="col-md-6 mb-3">
            <label for="firstDeregister" class="form-label">Дата окончания</label>
            <input type="date" class="form-control" id="firstDeregister">
        </div>

        <div class="col-md-6 mb-3">
            <label for="data-select">Участок:</label>
            <select id="dataSelectLand">
                <option value="">Загрузка...</option>
            </select>
        </div>
    </div>
    <div class="mb-3">
        <label for="diagnosis" class="form-label">Диагноз</label>
        <textarea class="form-control" id="diagnosis" rows="3"></textarea>
    </div>
    <div class="mb-3">
        <label for="notes" class="form-label">Заметки / Лечение</label>
        <textarea class="form-control" id="notes" rows="3"></textarea>
    </div>
    <!-- Добавим сюда другие поля из таблицы Register при необходимости -->
    </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Отмена
        </button>
        <button type="button" class="btn btn-primary" id="saveRegisterEntryBtn">
            Сохранить запись
        </button>
    </div>
    </div>
    </div>
    </div>
</body>
</html>